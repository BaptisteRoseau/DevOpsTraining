# Enable Container Registry

Currently, there is no container registry in my server:

![No container Registry](assets/no_container_registry.png)

As stated in [GitLab's container registry documentation](https://docs.gitlab.com/ee/administration/packages/container_registry.html#enable-the-container-registry):

> The Container Registry is automatically enabled and available on your GitLab domain, port 5050 if you’re using the built-in Let’s Encrypt integration.

I _could_ set up my own container registry, that is in fact what I would do in a company because such a registry can be used by other products than GitLab and you could ensure all the users use only this registry to avoid an unintentional leak to a public registry such as Docker Hub.

This is out of the scope of this task, so let's just add HTTPS support using let's encrypt to our GitLab.

## Add HTTPS Support

To enable HTTPS, nothing complicated, just use `https://` in the URL. GitLab will automatically use [Let's Encrypt](https://letsencrypt.org/) to generate the certificates.

Just update the `$GITLAB_HOME/config/gitlab.rb`:

```ruby
external_url "https://shynamo-gitlab"
```

If your company already have SSL certificate and key, just add them if the configuration file (see the [documentation](https://docs.gitlab.com/omnibus/settings/ssl/index.html#change-the-default-ssl-certificate-location)):

```ruby
nginx['ssl_certificate'] = "/mnt/gitlab/ssl/gitlab.crt"
nginx['ssl_certificate_key'] = "/mnt/gitlab/ssl/gitlab.key"
```

I strongly recommend using your own certificate instead of the self-signed one generated by [Let's Encrypt](https://letsencrypt.org/). Maybe it is self-signed because of the `.local` suffix.

### Invalid Domain Name

However, [Let's Encrypt](https://letsencrypt.org/) requires at least a dot in the domain name:

```log
[2023-05-21T08:27:00+00:00] FATAL: Acme::Client::Error::RejectedIdentifier: letsencrypt_certificate[shynamo-gitlab] (letsencrypt::http_authorization line 6) had an error: Acme::Client::Error::RejectedIdentifier: acme_certificate[staging] (letsencrypt::http_authorization line 43) had an error: Acme::Client::Error::RejectedIdentifier: Error creating new order :: Cannot issue for "shynamo-gitlab": Domain name needs at least one dot
```

Let's change our NGINX and GitLab server to use `gitlab.shynamo` instead of `shynamo-gitlab` in:

- `/root/nginx.conf`
- `$GITLAB_HOME/config/gitlab.rb`
- `/etc/hosts`
- `~/.ssh/config`
- `/etc/gitlab-runner/config.toml`
- The gitlab container's hostname (not mandatory, but for consistency purposes)

Too bad for us, the suffix is not valid:

```log
[2023-05-21T08:42:40+00:00] FATAL: Acme::Client::Error::RejectedIdentifier: letsencrypt_certificate[gitlab.shynamo] (letsencrypt::http_authorization line 6) had an error: Acme::Client::Error::RejectedIdentifier: acme_certificate[staging] (letsencrypt::http_authorization line 43) had an error: Acme::Client::Error::RejectedIdentifier: Error creating new order :: Cannot issue for "gitlab.shynamo": Domain name does not end with a valid public suffix (TLD)
```

Because I run the server on localhost, let's add the `.local` suffix, hence `gitlab.shynamo.local`, re-configure everything and restart the service:

```bash
systemctl --user start container-gitlab
```

### HTTPS Redirection Error

Another error, the NGINX HTTPS redirection does not work. To fix this, I need to bind the `$GITLAB_HOME/config/ssl` into the NGINX container, and use an HTTPS redirection:

```nginx
  server {
    listen 443 ssl;
    server_name gitlab.shynamo.local;

    ssl_certificate /ssl/gitlab.shynamo.local.crt;
    ssl_certificate_key /ssl/gitlab.shynamo.local.key;

    location / {
      proxy_pass https://localhost:20443;
      proxy_set_header Host $host;
    }
  }
```

I updated the NGINX container run command to the following and reconfigured systemctl:

```bash
sudo podman run \
    --detach \
    --restart always \
    --network host \
    -v /root/nginx.conf:/etc/nginx/nginx.conf \
    -v /home/baptiste/GitLabServer/gitlab/config/ssl:/ssl \
    --name nginx \
    nginx
```

And FINALLY I can connect to my local gitlab through HTTPS.

However, still no container registry in the GUI.

## Forward The Required Ports

GitLab provides [many ports](https://docs.gitlab.com/ee/administration/package_information/defaults.html) to be able to interact with it. One of them is required to use the container registry, 5050 by default. I decided it was time to forward all ports I may use during my training.

First, stop the service:

```bash
systemctl --user stop container-gitlab.service
```

Then, run the gitlab container with additional ports:

```bash
podman run \
    --detach \
    --hostname gitlab.shynamo.local \
    --publish 2022:22 \
    --publish 2080:80 \
    --publish 5000:5000 \
    --publish 5050:5050 \
    --publish 8083:8083 \
    --publish 9090:9090 \
    --publish 9100:9100 \
    --publish 9168:9168 \
    --publish 9187:9187 \
    --publish 9200:9200 \
    --publish 20443:443 \
    --publish 20465:20465 \
    --publish 20514:20514 \
    --name gitlab \
    --restart always \
    --volume $GITLAB_HOME/config:/etc/gitlab \
    --volume $GITLAB_HOME/logs:/var/log/gitlab \
    --volume $GITLAB_HOME/data:/var/opt/gitlab \
    --shm-size 256m \
    gitlab/gitlab-ee:latest
```

Finally, re-configure the service:

```bash
podman generate systemd --new --name gitlab -f
mkdir ~/.config/systemd/user/
mv container-gitlab.service ~/.config/systemd/user/
systemctl --user daemon-reload
systemctl --user enable container-gitlab.service
```

And that's it, now all interesting ports are correctly forwarded. All that remains to do is update the NGINX configuration to forward SMTP and Remote Syslog ports from 465 and 514 to 20465 and 20514 respectively.

## Update The NGINX Configuration

To forward SMTP and Remote Syslog ports from 465 and 514 to 20465 and 20514 respectively, add the following blocks in the NGINX configuration.

```nginx
stream {
  server {
    listen gitlab.shynamo:514;
    proxy_pass localhost:20514;
    proxy_protocol on;
  }
}

mail {
  server_name gitlab.shynamo;
  auth_http   localhost:20465;
  xclient off;

  server {
    listen     465;
    protocol   smtp;
    smtp_auth  none;
  }
}
```

Then, restart the service:

```bash
sudo systemctl restart container-nginx
```

And that's it, now SMTP and Remote Syslog will correctly be forwarded.
